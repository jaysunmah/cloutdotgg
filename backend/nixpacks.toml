[phases.setup]
aptPkgs = ["postgresql-client", "curl"]
nixPkgs = ["go"]

[phases.generate]
dependsOn = ["setup"]
cmds = [
    "curl -sSL https://github.com/bufbuild/buf/releases/download/v1.47.2/buf-Linux-x86_64 -o /usr/local/bin/buf && chmod +x /usr/local/bin/buf",
    "cp -r ../proto .",
    "cd proto && buf dep update && cd ..",
    "mkdir -p internal/gen",
    "buf generate proto",
    "rm -rf proto"
]

[phases.build]
dependsOn = ["generate"]
cmds = ["go build -o server ."]

[start]
cmd = "sh -c 'for f in migrations/*.sql; do psql $DATABASE_URL -f $f; done && ./server'"
